## TCP 协议如何保证可靠传输

2018.08.23 09:41

来源：[https://www.jianshu.com/p/6aac4b2a9fd7](https://www.jianshu.com/p/6aac4b2a9fd7)


            
-----

### UDP&TCP
 **`UDP：`** 


* (1) UDP，user datagram protocol，用户数据报协议，不提供复杂的控制机制，利用IP提供面向无连接的通信服务，并且它是将应用程序发送过来的数据包在收到的那一刻，立即按照原样发送到上的一种机制。

* (2) 即使在网络拥堵的情况下，UDP也无法进行流量控制等避免网络拥塞的行为。此外，在传输过程中如果出现丢包，UDP也不负责重发，甚至当数据包的到达顺序乱掉之后也没有纠正顺序的功能。因此，如果需要这些细节控制的话，就需要在采用UDP协议的应用层去作出处理。

* (3) 由于UDP面向无连接，所以它可以随时向对端发送数据包，再加上UDP本身的处理既简单右高效，所以UDP经常用于如下几个方面：

 **`使用场景`** 


* 数据包总量比较少的通信，比如DNS、SNMP。
* 视频、音频等对实时性要求比较高的多媒体通信。
* 广播通信、多播通信。


-----
 **`TCP：`** 


![][0]


* **`TCP`** ，控制传输协议，和UDP的差别很大，它充分实现了数据传输时的各种控制功能：
* 针对发送端发出的数据包的确认应答信号ACK
* 针对数据包丢失或者出现定时器超时的重发机制
* 针对数据包到达接收端主机顺序乱掉的顺序控制
* 针对高效传输数据包的流动窗口控制
* 针对避免网络拥堵时候的流量控制
* 针对刚开始启动的时候避免一下子发送大量数据包而导致网络瘫痪的慢启动算法和拥塞控制。

而这些在UDP中都是没有的！此外，TCP作为一种面向有连接的控制传输协议，只有在确认对端主机存在时才会发送数据，从而可以控制通信流量的浪费。

 **`TCP通过序列号、检验和、确认应答信号、重发控制、连接管理、窗口控制、流量控制、拥塞控制实现可靠性。`** 

-----

### TCP 协议如何保证可靠传输


* 应用数据被分割成 TCP 认为最适合发送的数据块。
* TCP 给发送的每一个包进行编号，接收方对数据包进行排序，把有序数据传送给应用层。
* **`校验和`** ： TCP 将保持它首部和数据的检验和。这是一个端到端的检验和，目的是检测数据在传输过程中的任何变化。如果收到段的检验和有差错，TCP 将丢弃这个报文段和不确认收到此报文段。
* TCP 的接收端会丢弃重复的数据。
* **`流量控制`** ： TCP 连接的每一方都有固定大小的缓冲空间，TCP的接收端只允许发送端发送接收端缓冲区能接纳的数据。当接收方来不及处理发送方的数据，能提示发送方降低发送的速率，防止包丢失。TCP 使用的流量控制协议是可变大小的滑动窗口协议。 （TCP 利用滑动窗口实现流量控制）
* **`拥塞控制`** ： 当网络拥塞时，减少数据的发送。
* **`停止等待协议`** : 也是为了实现可靠传输的，它的基本原理就是每发完一个分组就- 停止发送，等待对方确认。在收到确认后再发下一个分组。 超时重传： 当 TCP 发出一个段后，它启动一个定时器，等待目的端确认收到这个报文段。如果不能及时收到一个确认，将重发这个报文段。


-----
 **`停止等待协议`** 

停止等待协议是为了实现可靠传输的，它的基本原理就是每发完一个分组就停止发送，等待对方确认。在收到确认后再发下一个分组；

在停止等待协议中，若接收方收到重复分组，就丢弃该分组，但同时还要发送确认；

-----
 **`无差错情况:`** 


![][1]


发送方发送分组,接收方在规定时间内收到,并且回复确认.发送方再次发送。

-----
 **`出现差错情况（超时重传）:`** 


![][2]


停止等待协议中超时重传是指只要超过一段时间仍然没有收到确认，就重传前面发送过的分组（认为刚才发送过的分组丢失了）。因此每发送完一个分组需要设置一个超时计时器，其重转时间应比数据在分组传输的平均往返时间更长一些。这种自动重传方式常称为 自动重传请求 ARQ 。另外在停止等待协议中若收到重复分组，就丢弃该分组，但同时还要发送确认。连续 ARQ 协议 可提高信道利用率。发送维持一个发送窗口，凡位于发送窗口内的分组可连续发送出去，而不需要等待对方确认。接收方一般采用累积确认，对按序到达的最后一个分组发送确认，表明到这个分组位置的所有分组都已经正确收到了。

-----
 **`确认丢失和确认迟到`** 

确认丢失：确认消息在传输过程丢失


![][3]


当A发送M1消息，B收到后，B向A发送了一个M1确认消息，但却在传输过程中丢失。而A并不知道，在超时计时过后，A重传M1消息，B再次收到该消息后采取以下两点措施：


丢弃这个重复的M1消息，不向上层交付。

向A发送确认消息。（不会认为已经发送过了，就不再发送。A能重传，就证明B的确认消息丢失）。

确认迟到 ：确认消息在传输过程中迟到


![][4]


A发送M1消息，B收到并发送确认。在超时时间内没有收到确认消息，A重传M1消息，B仍然收到并继续发送确认消息（B收到了2份M1）。此时A收到了B第二次发送的确认消息。接着发送其他数据。过了一会，A收到了B第一次发送的对M1的确认消息（A也收到了2份确认消息）。处理如下：


* A收到重复的确认后，直接丢弃。
* B收到重复的M1后，也直接丢弃重复的M1。


-----
 **`自动重传请求 ARQ 协议`** 

停止等待协议中超时重传是指只要超过一段时间仍然没有收到确认，就重传前面发送过的分组（认为刚才发送过的分组丢失了）。因此每发送完一个分组需要设置一个超时计时器，其重转时间应比数据在分组传输的平均往返时间更长一些。这种自动重传方式常称为自动重传请求ARQ。


* 优点： 简单
* 缺点： 信道利用率低


-----
 **`连续ARQ协议`** 

连续 ARQ 协议可提高信道利用率。发送方维持一个发送窗口，凡位于发送窗口内的分组可以连续发送出去，而不需要等待对方确认。接收方一般采用累计确认，对按序到达的最后一个分组发送确认，表明到这个分组为止的所有分组都已经正确收到了。


* 优点： 信道利用率高，容易实现，即使确认丢失，也不必重传。
* 缺点： 不能向发送方反映出接收方已经正确收到的所有分组的信息。 比如：发送方发送了 5条 消息，中间第三条丢失（3号），这时接收方只能对前两个发送确认。发送方无法知道后三个分组的下落，而只好把后三个全部重传一次。这也叫 Go-Back-N（回退 N），表示需要退回来重传已经发送过的 N 个消息。


-----
 **`滑动窗口`** 


* TCP 利用滑动窗口实现流量控制的机制。
* 滑动窗口（Sliding window）是一种流量控制技术。早期的网络通信中，通信双方不会考虑网络的拥挤情况直接发送数据。由于大家不知道网络拥塞状况，同时发送数据，导致中间节点阻塞掉包，谁也发不了数据，所以就有了滑动窗口机制来解决此问题。
* TCP 中采用滑动窗口来进行传输控制，滑动窗口的大小意味着接收方还有多大的缓冲区可以用于接收数据。发送方可以通过滑动窗口的大小来确定应该发送多少字节的数据。当滑动窗口为 0 时，发送方一般不能再发送数据报，但有两种情况除外，一种情况是可以发送紧急数据，例如，允许用户终止在远端机上的运行进程。另一种情况是发送方可以发送一个 1 字节的数据报来通知接收方重新声明它希望接收的下一字节及发送方的滑动窗口大小。


-----
 **`流量控制`** 


* TCP 利用滑动窗口实现流量控制。
* 流量控制是为了控制发送方发送速率，保证接收方来得及接收。
* 接收方发送的确认报文中的窗口字段可以用来控制发送方窗口大小，从而影响发送方的发送速率。将窗口字段设置为 0，则发送方不能发送数据。


-----
 **`拥塞控制`** 

在某段时间，若对网络中某一资源的需求超过了该资源所能提供的可用部分，网络的性能就要变坏。这种情况就叫拥塞。拥塞控制就是为了防止过多的数据注入到网络中，这样就可以使网络中的路由器或链路不致过载。拥塞控制所要做的都有一个前提，就是网络能够承受现有的网络负荷。拥塞控制是一个全局性的过程，涉及到所有的主机，所有的路由器，以及与降低网络传输性能有关的所有因素。相反，流量控制往往是点对点通信量的控制，是个端到端的问题。流量控制所要做到的就是抑制发送端发送数据的速率，以便使接收端来得及接收。

为了进行拥塞控制，TCP 发送方要维持一个 拥塞窗口(cwnd) 的状态变量。拥塞控制窗口的大小取决于网络的拥塞程度，并且动态变化。发送方让自己的发送窗口取为拥塞窗口和接收方的接受窗口中较小的一个。

TCP的拥塞控制采用了四种算法，即 **`慢开始 、 拥塞避免 、快重传 和 快恢复`** 。在网络层也可以使路由器采用适当的分组丢弃策略（如主动队列管理 AQM），以减少网络拥塞的发生。


* **`慢开始`** ： 慢开始算法的思路是当主机开始发送数据时，如果立即把大量数据字节注入到网络，那么可能会引起网络阻塞，因为现在还不知道网络的符合情况。经验表明，较好的方法是先探测一下，即由小到大逐渐增大发送窗口，也就是由小到大逐渐增大拥塞窗口数值。cwnd初始值为1，每经过一个传播轮次，cwnd加倍。


![][5]

 **`拥塞避免`** ： 拥塞避免算法的思路是让拥塞窗口cwnd缓慢增大，即每经过一个往返时间RTT就把发送放的cwnd加1.
 **`快重传与快恢复：`** 

在 TCP/IP 中，快速重传和恢复（fast retransmit and recovery，FRR）是一种拥塞控制算法，它能快速恢复丢失的数据包。没有 FRR，如果数据包丢失了，TCP 将会使用定时器来要求传输暂停。在暂停的这段时间内，没有新的或复制的数据包被发送。有了 FRR，如果接收机接收到一个不按顺序的数据段，它会立即给发送机发送一个重复确认。如果发送机接收到三个重复确认，它会假定确认件指出的数据段丢失了，并立即重传这些丢失的数据段。有了 FRR，就不会因为重传时要求的暂停被耽误。  当有单独的数据包丢失时，快速重传和恢复（FRR）能最有效地工作。当有多个数据信息包在某一段很短的时间内丢失时，它则不能很有效地工作。


![][6]


[0]: ./img/3256507-055585bce48d603f.png
[1]: ./img/3256507-8c5662098685040e.png
[2]: ./img/3256507-528054e4a0cad4c0.png
[3]: ./img/3256507-6c6f83c2e096afd6.png
[4]: ./img/3256507-74c114877f8b0f0d.png
[5]: ./img/3256507-f25ac15d584e4163.png
[6]: ./img/3256507-d97c8b1425c23a6e.png