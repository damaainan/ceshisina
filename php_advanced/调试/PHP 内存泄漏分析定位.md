## PHP å†…å­˜æ³„æ¼åˆ†æå®šä½

 ä½œè€…/åˆ†äº«äººï¼š [é‚¹æ¯…ğŸ¸][0]

### ç›®å½•

* [åœºæ™¯ä¸€ ç¨‹åºæ“ä½œæ•°æ®è¿‡å¤§][1]
* [åœºæ™¯äºŒ ç¨‹åºæ“ä½œå¤§æ•°æ®æ—¶äº§ç”Ÿæ‹·è´][2]
* [åœºæ™¯ä¸‰ é…ç½®ä¸åˆç†ç³»ç»Ÿèµ„æºè€—å°½][3]
* [åœºæ™¯å›› æ— ç”¨çš„æ•°æ®æœªåŠæ—¶é‡Šæ”¾][4]
* [æ·±å…¥äº†è§£][5]
* [phpå†…å­˜ç®¡ç†][6]
* [php-fpmå†…å­˜æ³„éœ²é—®é¢˜][7]
* [å¸¸é©»è¿›ç¨‹å†…å­˜æ³„éœ²é—®é¢˜][8]

### å‰è¨€

æœ¬æ–‡å¼€å§‹æ’°å†™æ—¶æˆ‘è´Ÿè´£çš„é¡¹ç›®éœ€è¦ç”¨phpå¼€å‘ä¸€ä¸ªé€šè¿‡ Socket ä¸æœåŠ¡ç«¯å»ºç«‹é•¿è¿æ¥åæŒç»­å®æ—¶ä¸ŠæŠ¥æ•°æ®çš„å¸¸é©»è¿›ç¨‹ç¨‹åºï¼Œåœ¨ç¨‹åºä¸šåŠ¡åŠŸèƒ½å¼€å‘è”è°ƒå®Œæ¯•åå®é™…è¿è¡Œå‘é€å¤§é‡æ•°æ®åå‘ç°å†…å­˜å¢é•¿éå¸¸è¿…é€Ÿï¼Œåœ¨å¾ˆçŸ­çš„æ—¶é—´å†…è¾¾åˆ°äº† php é»˜è®¤å¯ç”¨å†…å­˜ä¸Šé™ 128M ï¼Œå¹¶æŠ¥é”™ï¼š

    Fatal error: Allowed memory size of X bytes exhausted (tried to allocate Y bytes)
    

æˆ‘ç¬¬ä¸€ååº”æ˜¯å†…å­˜æ³„éœ²äº†ï¼Œä½†æ˜¯ä¸çŸ¥é“åœ¨å“ªã€‚ç¬¬äºŒååº”æ˜¯æ— ç”¨çš„å˜é‡åº”è¯¥ç”¨å®Œå°± unset æ‰ï¼Œä¿®æ”¹å®Œæ¯•åé—®é¢˜ä¾æ—§ã€‚ç»è¿‡äº†å‡ ç•ªå‘¨æŠ˜ç»ˆäºè§£å†³äº†é—®é¢˜ã€‚å°±å†³å®šå¥½å¥½æŠŠç±»ä¼¼æƒ…å†µæ•´ç†ä¸€ä¸‹ï¼Œé‚æœ‰æ­¤æ–‡ï¼Œä¸è¯¸å›å…±å‹‰ã€‚

### è§‚å¯Ÿ PHP ç¨‹åºå†…å­˜ä½¿ç”¨æƒ…å†µ

phpææä¾›äº†ä¸¤ä¸ªæ–¹æ³•æ¥è·å–å½“å‰ç¨‹åºçš„å†…å­˜ä½¿ç”¨æƒ…å†µã€‚

* memory_get_usage()ï¼Œè¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯è·å–ç›®å‰PHPè„šæœ¬æ‰€ç”¨çš„å†…å­˜å¤§å°ã€‚
* memory_get_peak_usage()ï¼Œè¿™ä¸ªå‡½æ•°çš„ä½œç”¨è¿”å›å½“å‰è„šæœ¬åˆ°ç›®å‰ä½ç½®æ‰€å ç”¨çš„å†…å­˜å³°å€¼ï¼Œè¿™æ ·å°±å¯èƒ½è·å–åˆ°ç›®å‰çš„è„šæœ¬çš„å†…å­˜éœ€æ±‚æƒ…å†µã€‚

```
    int memory_get_usage ([ bool $real_usage = false ] )
    int memory_get_peak_usage ([ bool $real_usage = false ] )
```

å‡½æ•°é»˜è®¤å¾—åˆ°çš„æ˜¯è°ƒç”¨emalloc()å ç”¨çš„å†…å­˜ï¼Œå¦‚æœè®¾ç½®å‚æ•°ä¸ºTRUEï¼Œåˆ™å¾—åˆ°çš„æ˜¯å®é™…ç¨‹åºå‘ç³»ç»Ÿç”³è¯·çš„å†…å­˜ã€‚å› ä¸º PHP æœ‰è‡ªå·±çš„å†…å­˜ç®¡ç†æœºåˆ¶ï¼Œæ‰€ä»¥æœ‰æ—¶å€™å°½ç®¡å†…éƒ¨å·²ç»é‡Šæ”¾äº†å†…å­˜ä½†å¹¶æ²¡æœ‰è¿˜ç»™ç³»ç»Ÿã€‚

linux ç³»ç»Ÿæ–‡ä»¶ /proc/{$pid}/status ä¼šè®°å½•æŸä¸ªè¿›ç¨‹çš„è¿è¡ŒçŠ¶æ€ï¼Œé‡Œé¢çš„ VmRSS å­—æ®µè®°å½•äº†è¯¥è¿›ç¨‹ä½¿ç”¨çš„å¸¸é©»ç‰©ç†å†…å­˜(Residence)ï¼Œè¿™ä¸ªå°±æ˜¯è¯¥è¿›ç¨‹å®é™…å ç”¨çš„ç‰©ç†å†…å­˜äº†ï¼Œç”¨è¿™ä¸ªæ•°æ®æ¯”è¾ƒé è°±ï¼Œåœ¨ç¨‹åºé‡Œé¢æå–è¿™ä¸ªå€¼ä¹Ÿå¾ˆå®¹æ˜“

### åœºæ™¯ä¸€ï¼šç¨‹åºæ“ä½œæ•°æ®è¿‡å¤§

**æƒ…æ™¯è¿˜åŸ**ï¼šä¸€æ¬¡æ€§è¯»å–è¶…è¿‡phpå¯ç”¨å†…å­˜ä¸Šé™çš„æ•°æ®å¯¼è‡´å†…å­˜è€—å°½

```php
    <?php
    ini_set('memory_limit', '128M');
    $string = str_pad('1', 128 * 1024 * 1024);
```

```
    Fatal error: Allowed memory size of 134217728 bytes exhausted (tried to allocate 134217729 bytes) in /Users/zouyi/php-oom/bigfile.php on line 3
```

è¿™æ˜¯å‘Šè¯‰æˆ‘ä»¬ç¨‹åºè¿è¡Œæ—¶è¯•å›¾åˆ†é…æ–°å†…å­˜æ—¶ç”±äºè¾¾åˆ°äº†PHPå…è®¸åˆ†é…çš„å†…å­˜ä¸Šé™è€ŒæŠ›å‡ºè‡´å‘½é”™è¯¯ï¼Œæ— æ³•ç»§ç»­æ‰§è¡Œäº†ï¼Œåœ¨ java å¼€å‘ä¸­ä¸€èˆ¬ç§°ä¹‹ä¸º OOM ( Out Of Memory ) ã€‚

PHP é…ç½®å†…å­˜ä¸Šé™æ˜¯åœ¨php.iniä¸­è®¾ç½®memory_limitï¼ŒPHP 5.2 ä»¥å‰è¿™ä¸ªé»˜è®¤å€¼æ˜¯8Mï¼ŒPHP 5.2 çš„é»˜è®¤å€¼æ˜¯16Mï¼Œåœ¨è¿™ä¹‹åçš„ç‰ˆæœ¬é»˜è®¤å€¼éƒ½æ˜¯128Mã€‚

**é—®é¢˜ç°è±¡**ï¼šç‰¹å®šæ•°æ®å¤„ç†æ—¶å¯å¤ç°ï¼Œåšä»»ä½• IO æ“ä½œéƒ½æœ‰å¯èƒ½é‡åˆ°æ­¤ç±»é—®é¢˜ï¼Œæ¯”å¦‚ï¼šä¸€æ¬¡ mysql æŸ¥è¯¢è¿”å›å¤§é‡æ•°æ®ã€ä¸€æ¬¡æŠŠå¤§æ–‡ä»¶è¯»å–è¿›ç¨‹åºç­‰ã€‚

**è§£å†³æ–¹æ³•**ï¼š

1. èƒ½ç”¨é’±è§£å†³çš„é—®é¢˜éƒ½ä¸æ˜¯é—®é¢˜ï¼Œå¦‚æœç¨‹åºè¦è¯»å¤§æ–‡ä»¶çš„æœºä¼šä¸æ˜¯å¾ˆå¤šï¼Œä¸”ä¸Šé™å¯é¢„æœŸï¼Œé‚£ä¹ˆé€šè¿‡ini_set('memory_limit', '1G');æ¥è®¾ç½®ä¸€ä¸ªæ›´å¤§çš„å€¼æˆ–è€…memory_limit=-1ã€‚å†…å­˜ç®¡å¤Ÿçš„è¯è®©ç¨‹åºä¸€ç›´è·‘ä¹Ÿå¯ä»¥ã€‚
1. å¦‚æœç¨‹åºéœ€è¦è€ƒè™‘åœ¨å°å†…å­˜æœºå™¨ä¸Šä¹Ÿèƒ½æ­£å¸¸ä½¿ç”¨ï¼Œé‚£å°±éœ€è¦ä¼˜åŒ–ç¨‹åºäº†ã€‚å¦‚ä¸‹ï¼Œä»£ç å¤æ‚äº†å¾ˆå¤šã€‚

```php
    <?php
    //php7 ä»¥ä¸‹ç‰ˆæœ¬é€šè¿‡ composer å¼•å…¥ paragonie/random_compat ï¼Œä¸ºäº†æ–¹ä¾¿æ¥ç”Ÿæˆä¸€ä¸ªéšæœºåç§°çš„ä¸´æ—¶æ–‡ä»¶
    require "vendor/autoload.php";
    
    ini_set('memory_limit', '128M');
    //ç”Ÿæˆä¸´æ—¶æ–‡ä»¶å­˜æ”¾å¤§å­—ç¬¦ä¸²
    $fileName = 'tmp'.bin2hex(random_bytes(5)).'.txt';
    touch($fileName);
    for ( $i = 0; $i < 128; $i++ ) {
        $string = str_pad('1', 1 * 1024 * 1024);
        file_put_contents($fileName, $string, FILE_APPEND);
    }
    $handle = fopen($fileName, "r");
    for ( $i = 0; $i <= filesize($fileName) / 1 * 1024 * 1024; $i++ )
    {
       //do something
       $string = fread($handle, 1 * 1024 * 1024);
    }
    
    fclose($handle);
    unlink($fileName);
```

### åœºæ™¯äºŒï¼šç¨‹åºæ“ä½œå¤§æ•°æ®æ—¶äº§ç”Ÿæ‹·è´

**æƒ…æ™¯è¿˜åŸ**ï¼šæ‰§è¡Œè¿‡ç¨‹ä¸­å¯¹å¤§å˜é‡è¿›è¡Œäº†å¤åˆ¶ï¼Œå¯¼è‡´å†…å­˜ä¸å¤Ÿç”¨ã€‚

```php
    <?php
    ini_set("memory_limit",'1M');
    
    $string = str_pad('1', 1* 750 *1024);
    $string2 = $string;
    $string2 .= '1';
```

```
    Fatal error: Allowed memory size of 1048576 bytes exhausted (tried to allocate 768001 bytes) in /Users/zouyi/php-oom/unset.php on line 8
    
    Call Stack:
        0.0004     235440   1. {main}() /Users/zouyi/php-oom/unset.php:0
    
    zend_mm_heap corrupted
```

**é—®é¢˜ç°è±¡**ï¼šå±€éƒ¨ä»£ç æ‰§è¡Œè¿‡ç¨‹ä¸­å ç”¨å†…å­˜ç¿»å€ã€‚

**é—®é¢˜åˆ†æ**ï¼š

php æ˜¯å†™æ—¶å¤åˆ¶ï¼ˆCopy On Writeï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æ–°å˜é‡è¢«èµ‹å€¼æ—¶å†…å­˜ä¸å‘ç”Ÿå˜åŒ–ï¼Œç›´åˆ°æ–°å˜é‡çš„å†…å®¹è¢«æ“ä½œæ—¶æ‰ä¼šäº§ç”Ÿå¤åˆ¶ã€‚

**è§£å†³æ–¹æ³•**ï¼š

åŠæ—©é‡Šæ”¾æ— ç”¨å˜é‡ï¼Œæˆ–è€…ä»¥å¼•ç”¨çš„å½¢å¼æ“ä½œåŸå§‹æ•°æ®ã€‚

```php
    <?php
    ini_set("memory_limit",'1M');
    
    $string = str_pad('1', 1* 750 *1024);
    $string2 = $string;
    unset($string);
    $string2 .= '1';
```

```php
    <?php
    ini_set("memory_limit",'1M');
    
    $string = str_pad('1', 1* 750 *1024);
    $string2 = &$string;
    $string2 .= '1';
    
    unset($string2, $string);
```

### åœºæ™¯ä¸‰ï¼šé…ç½®ä¸åˆç†ç³»ç»Ÿèµ„æºè€—å°½

**æƒ…æ™¯è¿˜åŸ**ï¼šå› é…ç½®ä¸åˆç†å¯¼è‡´å†…å­˜ä¸å¤Ÿç”¨ï¼Œ2G å†…å­˜æœºå™¨ä¸Šè®¾ç½®æœ€å¤§å¯ä»¥å¯åŠ¨ 100 ä¸ª php-fpm å­è¿›ç¨‹ï¼Œä½†å®é™…å¯åŠ¨äº† 50 ä¸ª php-fpm å­è¿›ç¨‹åæ— æ³•å†å¯åŠ¨æ›´å¤šè¿›ç¨‹

**é—®é¢˜ç°è±¡**ï¼šçº¿ä¸Šä¸šåŠ¡è¯·æ±‚é‡å°çš„æ—¶å€™ä¸å‡ºç°é—®é¢˜ï¼Œè¯·æ±‚é‡ä¸€æ—¦å¾ˆå¤§åéƒ¨åˆ†è¯·æ±‚å°±ä¼šæ‰§è¡Œå¤±è´¥

**é—®é¢˜åˆ†æ**ï¼š

ä¸€èˆ¬ä¸ºäº†å®‰å…¨æ–¹é¢è€ƒè™‘ï¼Œ php é™åˆ¶è¡¨å•è¯·æ±‚çš„æœ€å¤§å¯æäº¤çš„æ•°é‡åŠå¤§å°ç­‰å‚æ•°ï¼Œpost_max_sizeã€max_file_uploadsã€upload_max_filesizeã€max_input_varsã€max_input_nesting_levelã€‚ å‡è®¾å¸¦å®½è¶³å¤Ÿï¼Œç”¨æˆ·é¢‘ç¹çš„æäº¤post_max_size = 8Mæ•°æ®åˆ°æœåŠ¡ç«¯ï¼Œnginx è½¬å‘ç»™ php-fpm å¤„ç†ï¼Œé‚£ä¹ˆæ¯ä¸ª php-fpm å­è¿›ç¨‹é™¤äº†è‡ªèº«å ç”¨çš„å†…å­˜å¤–ï¼Œå³ä½¿ä»€ä¹ˆéƒ½ä¸åšä¹Ÿæœ‰å¯èƒ½å¤šå ç”¨ 8M å†…å­˜ã€‚

**è§£å†³æ–¹æ³•**ï¼š

åˆç†è®¾ç½®post_max_sizeã€max_file_uploadsã€upload_max_filesizeã€max_input_varsã€max_input_nesting_levelç­‰å‚æ•°å¹¶è°ƒä¼˜ php-fpm ç›¸å…³å‚æ•°ã€‚

**php.ini**

```
    $ php -i |grep memory
    memory_limit => 1024M => 1024M //phpè„šæœ¬æ‰§è¡Œæœ€å¤§å¯ä½¿ç”¨å†…å­˜
    $php -i |grep max
    max_execution_time => 0 => 0 //æœ€å¤§æ‰§è¡Œæ—¶é—´ï¼Œè„šæœ¬é»˜è®¤ä¸º0ä¸é™åˆ¶ï¼Œwebè¯·æ±‚é»˜è®¤30s
    max_file_uploads => 20 => 20 //ä¸€ä¸ªè¡¨å•é‡Œæœ€å¤§ä¸Šä¼ æ–‡ä»¶æ•°é‡
    max_input_nesting_level => 64 => 64 //ä¸€ä¸ªè¡¨å•é‡Œæ•°æ®æœ€å¤§æ•°ç»„æ·±åº¦å±‚æ•°
    max_input_time => -1 => -1 //phpä»æ¥æ”¶è¯·æ±‚å¼€å§‹å¤„ç†æ•°æ®åçš„è¶…æ—¶æ—¶é—´
    max_input_vars => 1000 => 1000 //ä¸€ä¸ªè¡¨å•ï¼ˆåŒ…æ‹¬getã€postã€cookieçš„æ‰€æœ‰æ•°æ®ï¼‰æœ€å¤šæäº¤1000ä¸ªå­—æ®µ
    post_max_size => 8M => 8M //ä¸€æ¬¡postè¯·æ±‚æœ€å¤šæäº¤8Mæ•°æ®
    upload_max_filesize => 2M => 2M //ä¸€ä¸ªå¯ä¸Šä¼ çš„æ–‡ä»¶æœ€å¤§ä¸è¶…è¿‡2M
```

å¦‚æœä¸Šä¼ è®¾ç½®ä¸åˆç†é‚£ä¹ˆå‡ºç°å¤§é‡å†…å­˜è¢«å ç”¨çš„æƒ…å†µä¹Ÿä¸å¥‡æ€ªï¼Œæ¯”å¦‚æœ‰äº›å†…ç½‘åœºæ™¯ä¸‹éœ€è¦ post è¶…å¤§å­—ç¬¦ä¸²post_max_size=200Mï¼Œé‚£ä¹ˆå½“ä»è¡¨å•æäº¤äº† 200M æ•°æ®åˆ°æœåŠ¡ç«¯ï¼Œ php å°±ä¼šåˆ†é… 200M å†…å­˜ç»™è¿™æ¡æ•°æ®ï¼Œç›´åˆ°è¯·æ±‚å¤„ç†å®Œæ¯•é‡Šæ”¾å†…å­˜ã€‚

**php-fpm.conf**

```
    pm = dynamic //ä»…dynamicæ¨¡å¼ä¸‹ä»¥ä¸‹å‚æ•°ç”Ÿæ•ˆ
    pm.max_children = 10 //æœ€å¤§å­è¿›ç¨‹æ•°
    pm.start_servers = 3 //å¯åŠ¨æ—¶å¯åŠ¨å­è¿›ç¨‹æ•°
    pm.min_spare_servers = 2 //æœ€å°ç©ºé—²è¿›ç¨‹æ•°ï¼Œä¸å¤Ÿäº†å¯åŠ¨æ›´å¤šè¿›ç¨‹
    pm.max_spare_servers = 5 //æœ€å¤§ç©ºé—²è¿›ç¨‹æ•°ï¼Œè¶…è¿‡äº†ç»“æŸä¸€äº›è¿›ç¨‹
    pm.max_requests = 500 //æœ€å¤§è¯·æ±‚æ•°ï¼Œæ³¨æ„è¿™ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªphp-fpmå¦‚æœå¤„ç†äº†500ä¸ªè¯·æ±‚åä¼šè‡ªå·±é‡å¯ä¸€ä¸‹ï¼Œå¯ä»¥é¿å…ä¸€äº›ä¸‰æ–¹æ‰©å±•çš„å†…å­˜æ³„éœ²é—®é¢˜
```

ä¸€ä¸ª php-fpm è¿›ç¨‹æŒ‰ 30MB å†…å­˜ç®—ï¼Œ50 ä¸ª php-fpm è¿›ç¨‹å°±éœ€è¦ 1500MB å†…å­˜ï¼Œè¿™é‡Œéœ€è¦ç®€å•ä¼°ç®—ä¸€ä¸‹åœ¨è´Ÿè½½æœ€é‡çš„æƒ…å†µä¸‹æ‰€æœ‰ php-fpm è¿›ç¨‹éƒ½å¯åŠ¨åæ˜¯å¦ä¼šæŠŠç³»ç»Ÿå†…å­˜è€—å°½ã€‚

**ulimit**

```
    $ulimit -a
    -t: cpu time (seconds)              unlimited
    -f: file size (blocks)              unlimited
    -d: data seg size (kbytes)          unlimited
    -s: stack size (kbytes)             8192
    -c: core file size (blocks)         0
    -v: address space (kbytes)          unlimited
    -l: locked-in-memory size (kbytes)  unlimited
    -u: processes                       1024
    -n: file descriptors                1024
```

è¿™æ˜¯æˆ‘æœ¬åœ°mac osçš„é…ç½®ï¼Œæ–‡ä»¶æè¿°ç¬¦çš„è®¾ç½®æ˜¯æ¯”è¾ƒå°çš„ï¼Œä¸€èˆ¬ç”Ÿäº§ç¯å¢ƒé…ç½®è¦å¤§å¾—å¤šã€‚

### åœºæ™¯å››ï¼šæ— ç”¨çš„æ•°æ®æœªåŠæ—¶é‡Šæ”¾

**æƒ…æ™¯è¿˜åŸ**ï¼šè¿™ç§é—®é¢˜ä»ç¨‹åºé€»è¾‘ä¸Šä¸æ˜¯é—®é¢˜ï¼Œä½†æ˜¯æ— ç”¨çš„æ•°æ®å¤§é‡å ç”¨å†…å­˜å¯¼è‡´èµ„æºä¸å¤Ÿç”¨ï¼Œåº”è¯¥æœ‰é’ˆå¯¹æ€§çš„åšä»£ç ä¼˜åŒ–ã€‚

Laravelå¼€å‘ä¸­ç”¨äºç›‘å¬æ•°æ®åº“æ“ä½œæ—¶æœ‰å¦‚ä¸‹ä»£ç :

```
            DB::listen(function ($query) {
                // $query->sql
                // $query->bindings
                // $query->time
            });
```

å¯ç”¨æ•°æ®åº“ç›‘å¬åï¼Œæ¯å½“æœ‰ SQL æ‰§è¡Œæ—¶ä¼š new ä¸€ä¸ª QueryExecuted å¯¹è±¡å¹¶ä¼ å…¥åŒ¿åå‡½æ•°ä»¥ä¾¿åç»­æ“ä½œï¼Œå¯¹äºæ‰§è¡Œå®Œæ¯•å°±ç»“æŸè¿›ç¨‹é‡Šæ”¾èµ„æºçš„phpç¨‹åºæ¥è¯´æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œè€Œå¦‚æœæ˜¯ä¸€ä¸ªå¸¸é©»è¿›ç¨‹çš„ç¨‹åºï¼Œç¨‹åºæ¯æ‰§è¡Œä¸€æ¡ SQL å†…å­˜ä¸­å°±ä¼šå¢åŠ ä¸€ä¸ª QueryExecuted å¯¹è±¡ï¼Œç¨‹åºä¸ç»“æŸå†…å­˜å°±ä¼šå§‹ç»ˆå¢é•¿ã€‚

**é—®é¢˜ç°è±¡**ï¼šç¨‹åºè¿è¡ŒæœŸé—´å†…å­˜é€æ¸å¢é•¿ï¼Œç¨‹åºç»“æŸåå†…å­˜æ­£å¸¸é‡Šæ”¾ã€‚

**é—®é¢˜åˆ†æ**ï¼š

æ­¤ç±»é—®é¢˜ä¸æ˜“å¯Ÿè§‰ï¼Œå®šä½å›°éš¾ï¼Œå°¤å…¶æ˜¯æœ‰äº›æ¡†æ¶å°è£…å¥½çš„æ–¹æ³•ï¼Œè¦æ˜ç¡®å…¶é€‚ç”¨åœºæ™¯ã€‚

**è§£å†³æ–¹æ³•**ï¼š

æœ¬ä¾‹ä¸­è¦é€šè¿‡DB::listenæ–¹æ³•è·å–æ‰€æœ‰æ‰§è¡Œçš„ SQL è¯­å¥è®°å½•å¹¶å†™å…¥æ—¥å¿—ï¼Œä½†æ­¤æ–¹æ³•å­˜åœ¨å†…å­˜æ³„éœ²é—®é¢˜ï¼Œåœ¨å¼€å‘ç¯å¢ƒä¸‹æ— æ‰€è°“ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸‹åˆ™åº”åœç”¨ï¼Œæ”¹ç”¨å…¶ä»–é€”å¾„è·å–æ‰§è¡Œçš„ SQL è¯­å¥å¹¶å†™æ—¥å¿—ã€‚

### æ·±å…¥äº†è§£

#### 1. åè¯è§£é‡Š

* [å†…å­˜æ³„æ¼][9]ï¼ˆMemory Leakï¼‰ï¼šæ˜¯ç¨‹åºåœ¨ç®¡ç†å†…å­˜åˆ†é…è¿‡ç¨‹ä¸­æœªèƒ½æ­£ç¡®çš„é‡Šæ”¾ä¸å†ä½¿ç”¨çš„å†…å­˜å¯¼è‡´èµ„æºè¢«å¤§é‡å ç”¨çš„ä¸€ç§é—®é¢˜ã€‚åœ¨é¢å‘å¯¹è±¡ç¼–ç¨‹æ—¶ï¼Œé€ æˆå†…å­˜æ³„éœ²çš„åŸå› å¸¸å¸¸æ˜¯å¯¹è±¡åœ¨å†…å­˜ä¸­å­˜å‚¨ä½†æ˜¯è¿è¡Œä¸­çš„ä»£ç å´æ— æ³•è®¿é—®ä»–ã€‚ç”±äºäº§ç”Ÿç±»ä¼¼é—®é¢˜çš„æƒ…å†µå¾ˆå¤šï¼Œæ‰€ä»¥åªèƒ½ä»æºç ä¸Šå…¥æ‰‹åˆ†æå®šä½å¹¶è§£å†³ã€‚
* [åƒåœ¾å›æ”¶][10]ï¼ˆGarbage Collectionï¼Œç®€ç§°GCï¼‰ï¼šæ˜¯ä¸€ç§è‡ªåŠ¨å†…å­˜ç®¡ç†çš„å½¢å¼ï¼ŒGCç¨‹åºæ£€æŸ¥å¹¶å¤„ç†ç¨‹åºä¸­é‚£äº›å·²ç»åˆ†é…å‡ºå»ä½†å´ä¸å†è¢«å¯¹è±¡ä½¿ç”¨çš„å†…å­˜ã€‚æœ€æ—©çš„GCæ˜¯1959å¹´å‰åJohn McCarthyå‘æ˜çš„ï¼Œç”¨æ¥ç®€åŒ–åœ¨Lispä¸­æ‰‹åŠ¨æ§åˆ¶å†…å­˜ç®¡ç†ã€‚ PHPçš„å†…æ ¸ä¸­å·²è‡ªå¸¦å†…å­˜ç®¡ç†çš„åŠŸèƒ½ï¼Œä¸€èˆ¬åº”ç”¨åœºæ™¯ä¸‹ï¼Œä¸æ˜“å‡ºç°å†…å­˜æ³„éœ²ã€‚
* è¿½è¸ªæ³•ï¼ˆTracingï¼‰ï¼šä»æŸä¸ªæ ¹å¯¹è±¡å¼€å§‹è¿½è¸ªï¼Œæ£€æŸ¥å“ªäº›å¯¹è±¡å¯è®¿é—®ï¼Œé‚£ä¹ˆå…¶ä»–çš„ï¼ˆä¸å¯è®¿é—®ï¼‰å°±æ˜¯åƒåœ¾ã€‚
* å¼•ç”¨è®¡æ•°æ³•ï¼ˆreference countï¼‰ï¼šæ¯ä¸ªå¯¹è±¡éƒ½ä¸€ä¸ªæ•°å­—ç”¨æ¥æ ‡ç¤ºè¢«å¼•ç”¨çš„æ¬¡æ•°ã€‚å¼•ç”¨æ¬¡æ•°ä¸º0çš„å¯ä»¥å›æ”¶ã€‚å½“å¯¹ä¸€ä¸ªå¯¹è±¡çš„å¼•ç”¨åˆ›å»ºæ—¶ä»–çš„å¼•ç”¨è®¡æ•°å°±ä¼šå¢åŠ ï¼Œå¼•ç”¨é”€æ¯æ—¶è®¡æ•°å‡å°‘ã€‚å¼•ç”¨è®¡æ•°æ³•å¯ä»¥ä¿è¯å¯¹è±¡ä¸€æ—¦ä¸è¢«å¼•ç”¨æ—¶ç¬¬ä¸€æ—¶é—´é”€æ¯ã€‚ä½†æ˜¯å¼•ç”¨è®¡æ•°æœ‰ä¸€äº›ç¼ºé™·ï¼š1.å¾ªç¯å¼•ç”¨ï¼Œ2.å¼•ç”¨è®¡æ•°éœ€è¦ç”³è¯·æ›´å¤šå†…å­˜ï¼Œ3.å¯¹é€Ÿåº¦æœ‰å½±å“ï¼Œ4.éœ€è¦ä¿è¯åŸå­æ€§ï¼Œ5.ä¸æ˜¯å®æ—¶çš„

#### 2. php å†…å­˜ç®¡ç†

> åœ¨ PHP 5.2 ä»¥å‰, PHP ä½¿ç”¨å¼•ç”¨è®¡æ•°(Reference count)æ¥åšèµ„æºç®¡ç†, å½“ä¸€ä¸ª zval çš„å¼•ç”¨è®¡æ•°ä¸º 0 çš„æ—¶å€™, å®ƒå°±ä¼šè¢«é‡Šæ”¾. è™½ç„¶å­˜åœ¨å¾ªç¯å¼•ç”¨(Cycle reference), ä½†è¿™æ ·çš„è®¾è®¡å¯¹äºå¼€å‘ Web è„šæœ¬æ¥è¯´, æ²¡ä»€ä¹ˆé—®é¢˜, å› ä¸º Web è„šæœ¬çš„ç‰¹ç‚¹å’Œå®ƒè¿½æ±‚çš„ç›®æ ‡å°±æ˜¯æ‰§è¡Œæ—¶é—´çŸ­, ä¸ä¼šé•¿æœŸè¿è¡Œ. å¯¹äºå¾ªç¯å¼•ç”¨é€ æˆçš„èµ„æºæ³„éœ², ä¼šåœ¨è¯·æ±‚ç»“æŸæ—¶é‡Šæ”¾æ‰. ä¹Ÿå°±æ˜¯è¯´, è¯·æ±‚ç»“æŸæ—¶é‡Šæ”¾èµ„æº, æ˜¯ä¸€ç§éƒ¨è¡¥æ•‘æªæ–½( backup ).

> ç„¶è€Œ, éšç€ PHP è¢«è¶Šæ¥è¶Šå¤šçš„äººä½¿ç”¨, å°±æœ‰å¾ˆå¤šäººåœ¨ä¸€äº›åå°è„šæœ¬ä½¿ç”¨ PHP , è¿™äº›è„šæœ¬çš„ç‰¹ç‚¹æ˜¯é•¿æœŸè¿è¡Œ, å¦‚æœå­˜åœ¨å¾ªç¯å¼•ç”¨, å¯¼è‡´å¼•ç”¨è®¡æ•°æ— æ³•åŠæ—¶é‡Šæ”¾ä¸ç”¨çš„èµ„æº, åˆ™è¿™ä¸ªè„šæœ¬æœ€ç»ˆä¼šå†…å­˜è€—å°½é€€å‡º.

> æ‰€ä»¥åœ¨ PHP 5.3 ä»¥å, æˆ‘ä»¬å¼•å…¥äº† GC .

â€”â€” æ‘˜è‡ªé¸Ÿå“¥åšå®¢æ–‡ç« ã€Š[è¯·æ‰‹åŠ¨é‡Šæ”¾ä½ çš„èµ„æº][11]ã€‹

åœ¨ PHP 5.3 ä»¥åå¼•å…¥äº†åŒæ­¥å‘¨æœŸå›æ”¶ç®—æ³•(Concurrent Cycle Collection)æ¥å¤„ç†å†…å­˜æ³„éœ²é—®é¢˜ï¼Œä»£ä»·æ˜¯å¯¹æ€§èƒ½æœ‰ä¸€å®šå½±å“ï¼Œä¸è¿‡ä¸€èˆ¬ web è„šæœ¬åº”ç”¨ç¨‹åºå½±å“å¾ˆå°ã€‚PHPçš„åƒåœ¾å›æ”¶æœºåˆ¶æ˜¯é»˜è®¤æ‰“å¼€çš„ï¼Œphp.ini å¯ä»¥è®¾ç½®zend.enable_gc=0æ¥å…³é—­ã€‚ä¹Ÿèƒ½é€šè¿‡åˆ†åˆ«è°ƒç”¨gc_enable() å’Œ gc_disable()å‡½æ•°æ¥æ‰“å¼€å’Œå…³é—­åƒåœ¾å›æ”¶æœºåˆ¶ã€‚

è™½ç„¶åƒåœ¾å›æ”¶è®©phpå¼€å‘è€…åœ¨å†…å­˜ç®¡ç†ä¸Šæ— éœ€æ‹…å¿ƒäº†ï¼Œä½†ä¹Ÿæœ‰æç«¯çš„åä¾‹ï¼šphpç•Œè‘—åçš„åŒ…ç®¡ç†å·¥å…·composeræ›¾å› åŠ å…¥ä¸€è¡Œgc_disable();æ€§èƒ½å¾—åˆ°æå¤§æå‡ã€‚[ä¼ é€é—¨][12]

[å¼•ç”¨è®¡æ•°åŸºæœ¬çŸ¥è¯†][13]

[å›æ”¶å‘¨æœŸ(Collecting Cycles)][14]

ä¸Šé¢ä¸¤ä¸ªé“¾æ¥æ˜¯phpå®˜æ–¹æ‰‹å†Œä¸­çš„å†…å­˜ç®¡ç†ã€GCç›¸å…³çŸ¥è¯†è®²è§£ï¼Œå›¾æ–‡å¹¶èŒ‚ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚

#### 3. php-fpm å†…å­˜æ³„éœ²é—®é¢˜

åœ¨ä¸€å°å¸¸è§çš„ nginx + php-fpm çš„æœåŠ¡å™¨ä¸Šï¼š

1. nginx æœåŠ¡å™¨ fork å‡º n ä¸ªå­è¿›ç¨‹ï¼ˆworkerï¼‰ï¼Œ php-fpm ç®¡ç†å™¨ fork å‡º n ä¸ªå­è¿›ç¨‹ã€‚
1. å½“æœ‰ç”¨æˆ·è¯·æ±‚ï¼Œ nginx çš„ä¸€ä¸ª worker æ¥æ”¶è¯·æ±‚ï¼Œå¹¶å°†è¯·æ±‚æŠ›åˆ° socket ä¸­ã€‚
1. php-fpm ç©ºé—²çš„å­è¿›ç¨‹ç›‘å¬åˆ° socket ä¸­æœ‰è¯·æ±‚ï¼Œæ¥æ”¶å¹¶å¤„ç†è¯·æ±‚ã€‚

ä¸€ä¸ª php-fpm çš„ç”Ÿå‘½å‘¨æœŸå¤§è‡´æ˜¯è¿™æ ·çš„ï¼š

æ¨¡å—åˆå§‹åŒ–ï¼ˆMINITï¼‰-> è¯·æ±‚åˆå§‹åŒ–ï¼ˆRINITï¼‰-> è¯·æ±‚å¤„ç† -> è¯·æ±‚ç»“æŸï¼ˆRSHUTDOWNï¼‰ -> è¯·æ±‚åˆå§‹åŒ–ï¼ˆRINITï¼‰-> è¯·æ±‚å¤„ç† -> è¯·æ±‚ç»“æŸï¼ˆRSHUTDOWNï¼‰â€¦â€¦. è¯·æ±‚åˆå§‹åŒ–ï¼ˆRINITï¼‰-> è¯·æ±‚å¤„ç† -> è¯·æ±‚ç»“æŸï¼ˆRSHUTDOWNï¼‰-> æ¨¡å—å…³é—­ï¼ˆMSHUTDOWNï¼‰ã€‚

åœ¨è¯·æ±‚åˆå§‹åŒ–ï¼ˆRINITï¼‰-> è¯·æ±‚å¤„ç† -> è¯·æ±‚ç»“æŸï¼ˆRSHUTDOWNï¼‰è¿™ä¸ªâ€œè¯·æ±‚å¤„ç†â€è¿‡ç¨‹æ˜¯ï¼š php è¯»å–ç›¸åº”çš„ php æ–‡ä»¶ï¼Œå¯¹å…¶è¿›è¡Œè¯æ³•åˆ†æï¼Œç”Ÿæˆ opcode ï¼Œ zend è™šæ‹Ÿæœºæ‰§è¡Œ opcode ã€‚

php åœ¨æ¯æ¬¡è¯·æ±‚ç»“æŸåè‡ªåŠ¨é‡Šæ”¾å†…å­˜ï¼Œæœ‰æ•ˆé¿å…äº†å¸¸è§åœºæ™¯ä¸‹å†…å­˜æ³„éœ²çš„é—®é¢˜ï¼Œç„¶è€Œå®é™…ç¯å¢ƒä¸­å› æŸäº›æ‰©å±•çš„å†…å­˜ç®¡ç†æ²¡æœ‰åšå¥½æˆ–è€… php ä»£ç ä¸­å‡ºç°å¾ªç¯å¼•ç”¨å¯¼è‡´æœªèƒ½æ­£å¸¸é‡Šæ”¾ä¸ç”¨çš„èµ„æºã€‚

åœ¨ php-fpm é…ç½®æ–‡ä»¶ä¸­ï¼Œå°†pm.max_requestsè¿™ä¸ªå‚æ•°è®¾ç½®å°ä¸€ç‚¹ã€‚è¿™ä¸ªå‚æ•°çš„å«ä¹‰æ˜¯ï¼šä¸€ä¸ª php-fpm å­è¿›ç¨‹æœ€å¤šå¤„ç†pm.max_requestsä¸ªç”¨æˆ·è¯·æ±‚åï¼Œå°±ä¼šè¢«é”€æ¯ã€‚å½“ä¸€ä¸ª php-fpm è¿›ç¨‹è¢«é”€æ¯åï¼Œå®ƒæ‰€å ç”¨çš„æ‰€æœ‰å†…å­˜éƒ½ä¼šè¢«å›æ”¶ã€‚

#### 4. å¸¸é©»è¿›ç¨‹å†…å­˜æ³„éœ²é—®é¢˜

Valgrind åŒ…æ‹¬å¦‚ä¸‹ä¸€äº›å·¥å…·ï¼š

* Memcheckã€‚è¿™æ˜¯ valgrind åº”ç”¨æœ€å¹¿æ³›çš„å·¥å…·ï¼Œä¸€ä¸ªé‡é‡çº§çš„å†…å­˜æ£€æŸ¥å™¨ï¼Œèƒ½å¤Ÿå‘ç°å¼€å‘ä¸­ç»å¤§å¤šæ•°å†…å­˜é”™è¯¯ä½¿ç”¨æƒ…å†µï¼Œæ¯”å¦‚ï¼šä½¿ç”¨æœªåˆå§‹åŒ–çš„å†…å­˜ï¼Œä½¿ç”¨å·²ç»é‡Šæ”¾äº†çš„å†…å­˜ï¼Œå†…å­˜è®¿é—®è¶Šç•Œç­‰ã€‚
* Callgrindã€‚å®ƒä¸»è¦ç”¨æ¥æ£€æŸ¥ç¨‹åºä¸­å‡½æ•°è°ƒç”¨è¿‡ç¨‹ä¸­å‡ºç°çš„é—®é¢˜ã€‚
* Cachegrindã€‚å®ƒä¸»è¦ç”¨æ¥æ£€æŸ¥ç¨‹åºä¸­ç¼“å­˜ä½¿ç”¨å‡ºç°çš„é—®é¢˜ã€‚
* Helgrindã€‚å®ƒä¸»è¦ç”¨æ¥æ£€æŸ¥å¤šçº¿ç¨‹ç¨‹åºä¸­å‡ºç°çš„ç«äº‰é—®é¢˜ã€‚
* Massifã€‚å®ƒä¸»è¦ç”¨æ¥æ£€æŸ¥ç¨‹åºä¸­å †æ ˆä½¿ç”¨ä¸­å‡ºç°çš„é—®é¢˜ã€‚
* Extensionã€‚å¯ä»¥åˆ©ç”¨coreæä¾›çš„åŠŸèƒ½ï¼Œè‡ªå·±ç¼–å†™ç‰¹å®šçš„å†…å­˜è°ƒè¯•å·¥å…·ã€‚

Memcheck å¯¹è°ƒè¯• C/C++ ç¨‹åºçš„å†…å­˜æ³„éœ²å¾ˆæœ‰å¸®åŠ©ï¼Œå®ƒçš„æœºåˆ¶æ˜¯åœ¨ç³»ç»Ÿ alloc/free ç­‰å‡½æ•°è°ƒç”¨ä¸ŠåŠ è®¡æ•°ã€‚ php ç¨‹åºçš„å†…å­˜æ³„éœ²ï¼Œæ˜¯ç”±äºä¸€äº›å¾ªç¯å¼•ç”¨ï¼Œæˆ–è€… gc çš„é€»è¾‘é”™è¯¯, valgrind æ— æ³•æ¢æµ‹ï¼Œå› æ­¤éœ€è¦åœ¨æ£€æµ‹æ—¶éœ€è¦å…³é—­ php è‡ªå¸¦çš„å†…å­˜ç®¡ç†ã€‚

```
    $ export USE_ZEND_ALLOC=0   # è®¾ç½®ç¯å¢ƒå˜é‡å…³é—­å†…å­˜ç®¡ç†
    $ valgrind --tool=memcheck --num-callers=30 --log-file=php.log /Users/zouyi/Downloads/php-5.6.31/sapi/cli/php  leak.php
```

é€šè¿‡å‘½ä»¤è¡Œæ‰§è¡Œ valgrind åˆ†æå¯èƒ½æœ‰å†…å­˜æ³„éœ²çš„æ–‡ä»¶

```
    ==12075== Memcheck, a memory error detector
    ==12075== Copyright (C) 2002-2017, and GNU GPL'd, by Julian Seward et al.
    ==12075== Using Valgrind-3.13.0 and LibVEX; rerun with -h for copyright info
    ==12075== Command: /Users/zouyi/Downloads/php-5.6.31/sapi/cli/php leak.php
    ==12075== Parent PID: 42043
    ==12075==
    ==12075== Syscall param msg->desc.port.name points to uninitialised byte(s)
    ==12075==    at 0x10121F34A: mach_msg_trap (in /usr/lib/system/libsystem_kernel.dylib)
    ==12075==    by 0x10121E796: mach_msg (in /usr/lib/system/libsystem_kernel.dylib)
    ==12075==    by 0x101218485: task_set_special_port (in /usr/lib/system/libsystem_kernel.dylib)
    ==12075==    by 0x1013B410E: _os_trace_create_debug_control_port (in /usr/lib/system/libsystem_trace.dylib)
    ==12075==    by 0x1013B4458: _libtrace_init (in /usr/lib/system/libsystem_trace.dylib)
    ==12075==    by 0x100DF09DF: libSystem_initializer (in /usr/lib/libSystem.B.dylib)
    ==12075==    by 0x100C37A1A: ImageLoaderMachO::doModInitFunctions(ImageLoader::LinkContext const&) (in /usr/lib/dyld)
    ==12075==    by 0x100C37C1D: ImageLoaderMachO::doInitialization(ImageLoader::LinkContext const&) (in /usr/lib/dyld)
    ==12075==    by 0x100C334A9: ImageLoader::recursiveInitialization(ImageLoader::LinkContext const&, unsigned int, char const*, ImageLoader::InitializerTimingList&, ImageLoader::UninitedUpwards&) (in /usr/lib/dyld)
    ==12075==    by 0x100C33440: ImageLoader::recursiveInitialization(ImageLoader::LinkContext const&, unsigned int, char const*, ImageLoader::InitializerTimingList&, ImageLoader::UninitedUpwards&) (in /usr/lib/dyld)
    ==12075==    by 0x100C32523: ImageLoader::processInitializers(ImageLoader::LinkContext const&, unsigned int, ImageLoader::InitializerTimingList&, ImageLoader::UninitedUpwards&) (in /usr/lib/dyld)
    ==12075==    by 0x100C325B8: ImageLoader::runInitializers(ImageLoader::LinkContext const&, ImageLoader::InitializerTimingList&) (in /usr/lib/dyld)
    ==12075==    by 0x100C24433: dyld::initializeMainExecutable() (in /usr/lib/dyld)
    ==12075==    by 0x100C288C5: dyld::_main(macho_header const*, unsigned long, int, char const**, char const**, char const**, unsigned long*) (in /usr/lib/dyld)
    ==12075==    by 0x100C23248: dyldbootstrap::start(macho_header const*, int, char const**, long, macho_header const*, unsigned long*) (in /usr/lib/dyld)
    ==12075==    by 0x100C23035: _dyld_start (in /usr/lib/dyld)
    ==12075==    by 0x1: ???
    ==12075==    by 0x1054AC862: ???
    ==12075==    by 0x1054AC891: ???
    ==12075==  Address 0x1054aa98c is on thread 1's stack
    ==12075==  in frame #2, created by task_set_special_port (???:)
    ==12075==
    --12075-- UNKNOWN mach_msg unhandled MACH_SEND_TRAILER option
    --12075-- UNKNOWN mach_msg unhandled MACH_SEND_TRAILER option (repeated 2 times)
    --12075-- UNKNOWN mach_msg unhandled MACH_SEND_TRAILER option (repeated 4 times)
    ==12075==
    ==12075== HEAP SUMMARY:
    ==12075==     in use at exit: 125,805 bytes in 185 blocks
    ==12075==   total heap usage: 14,686 allocs, 14,501 frees, 3,261,322 bytes allocated
    ==12075==
    ==12075== LEAK SUMMARY:
    ==12075==    definitely lost: 3 bytes in 1 blocks
    ==12075==    indirectly lost: 0 bytes in 0 blocks
    ==12075==      possibly lost: 72 bytes in 3 blocks
    ==12075==    still reachable: 107,582 bytes in 23 blocks
    ==12075==         suppressed: 18,148 bytes in 158 blocks
    ==12075== Rerun with --leak-check=full to see details of leaked memory
    ==12075==
    ==12075== For counts of detected and suppressed errors, rerun with: -v
    ==12075== Use --track-origins=yes to see where uninitialised values come from
    ==12075== ERROR SUMMARY: 1 errors from 1 contexts (suppressed: 1 from 1)
```

```
    definitely lost: è‚¯å®šå†…å­˜æ³„éœ²
    indirectly lost: éç›´æ¥å†…å­˜æ³„éœ²
    possibly lost: å¯èƒ½å‘ç”Ÿå†…å­˜æ³„éœ²
    still reachable: ä»ç„¶å¯è®¿é—®çš„å†…å­˜
    suppressed: å¤–éƒ¨é€ æˆçš„å†…å­˜æ³„éœ²
```

Callgrind é…åˆ php æ‰©å±• xdebug è¾“å‡ºçš„ profile åˆ†ææ—¥å¿—æ–‡ä»¶å¯ä»¥åˆ†æç¨‹åºè¿è¡ŒæœŸé—´å„ä¸ªå‡½æ•°è°ƒç”¨æ—¶å ç”¨çš„å†…å­˜ã€ CPU å ç”¨æƒ…å†µã€‚

### æ€»ç»“

é‡åˆ°äº†å†…å­˜æ³„éœ²æ—¶å…ˆè§‚å¯Ÿæ˜¯ç¨‹åºæœ¬èº«å†…å­˜ä¸è¶³è¿˜æ˜¯å¤–éƒ¨èµ„æºå¯¼è‡´ï¼Œç„¶åææ¸…æ¥šç¨‹åºè¿è¡Œä¸­ç”¨åˆ°äº†å“ªäº›èµ„æºï¼šå†™å…¥ç£ç›˜æ—¥å¿—ã€è¿æ¥æ•°æ®åº“ SQL æŸ¥è¯¢ã€å‘é€ Curl è¯·æ±‚ã€ Socket é€šä¿¡ç­‰ï¼Œ I/O æ“ä½œå¿…ç„¶ä¼šç”¨åˆ°å†…å­˜ï¼Œå¦‚æœè¿™äº›åœ°æ–¹éƒ½æ²¡æœ‰å‘ç”Ÿæ˜æ˜¾çš„å†…å­˜æ³„éœ²ï¼Œæ£€æŸ¥å“ªé‡Œå¤„ç†å¤§é‡æ•°æ®æ²¡æœ‰åŠæ—¶é‡Šæ”¾èµ„æºï¼Œå¦‚æœæ˜¯ php 5.3 ä»¥ä¸‹ç‰ˆæœ¬è¿˜éœ€è€ƒè™‘å¾ªç¯å¼•ç”¨çš„é—®é¢˜ã€‚å¤šäº†è§£ä¸€äº› Linux ä¸‹çš„åˆ†æè¾…åŠ©å·¥å…·ï¼Œè§£å†³é—®é¢˜æ—¶å¯ä»¥äº‹åŠåŠŸå€ã€‚

æœ€åå®£ä¼ ä¸€ä¸‹ç©¿äº‘å›¢é˜Ÿä»Šå¹´æœ€æ–°å¼€æºçš„åº”ç”¨é€æ˜é“¾è·¯è¿½è¸ªå·¥å…· Moltenï¼š[https://github.com/chuan-yun/Molten][15]ã€‚å®‰è£…å¥½phpæ‰©å±•åå°±èƒ½å¸®ä½ å®æ—¶æ”¶é›†ç¨‹åºçš„ curl,pdo,mysqli,redis,mongodb,memcached ç­‰è¯·æ±‚çš„æ•°æ®ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„ä¸ zipkin é›†æˆã€‚

### å‚è€ƒèµ„æ–™

* http://php.net/manual/zh/features.gc.php
* http://www.php-internals.com/book/?p=chapt06/06-07-memory-leaks
* http://www.programering.com/a/MDN5UjMwATk.html
* https://stackoverflow.com/questions/20458136/using-valgrind-to-debug-a-php-cli-segmentation-fault
* http://www.laruence.com/2013/08/14/2899.html
* https://mengkang.net/873.html

[0]: http://gitbook.cn/gitchat/author/58b007f8db8bd6b81742d152
[1]: #åœºæ™¯ä¸€ç¨‹åºæ“ä½œæ•°æ®è¿‡å¤§
[2]: #åœºæ™¯äºŒç¨‹åºæ“ä½œå¤§æ•°æ®æ—¶äº§ç”Ÿæ‹·è´
[3]: #åœºæ™¯ä¸‰é…ç½®ä¸åˆç†ç³»ç»Ÿèµ„æºè€—å°½
[4]: #åœºæ™¯å››æ— ç”¨çš„æ•°æ®æœªåŠæ—¶é‡Šæ”¾
[5]: #æ·±å…¥äº†è§£
[6]: #phpå†…å­˜ç®¡ç†
[7]: #php-fpmå†…å­˜æ³„éœ²é—®é¢˜
[8]: #å¸¸é©»è¿›ç¨‹å†…å­˜æ³„éœ²é—®é¢˜
[9]: https://en.wikipedia.org/wiki/Memory_leak
[10]: https://en.wikipedia.org/wiki/Garbage_collection_(computer_science)
[11]: http://www.laruence.com/2012/07/25/2662.html
[12]: https://github.com/composer/composer/commit/ac676f47f7bbc619678a29deae097b6b0710b799
[13]: http://php.net/manual/zh/features.gc.refcounting-basics.php
[14]: http://docs.php.net/manual/zh/features.gc.collecting-cycles.php
[15]: https://github.com/chuan-yun/Molten