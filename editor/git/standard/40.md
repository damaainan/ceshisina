# RESTFul API è®¾è®¡

@AV 2015.04

====

## ä»€ä¹ˆæ˜¯REST

> Representational State Transfer

- è¡¨ç°å±‚
- çŠ¶æ€è½¬åŒ–

---

### ä»€ä¹ˆæ˜¯RESTFul

ç¬¦åˆRESTåŸåˆ™çš„æ¶æ„

---

### Why RESTFul

![Imgur](http://i.imgur.com/4NpJJf5.png?1)

> From http://www.programmableweb.com/

====

## HTTP

Request

```
POST /v1/oauth2/token HTTP/1.1
Host: api.example.com
Authorization: Basic Y2xpZW50X2lkOmNsaWVudF9zZWNyZXQ=
Content-Type: application/x-www-form-urlencoded

grant_type=password&username=takaaki&password=abcde&scope=api
```

---

Response

```
HTTP/1.1 200 OK
Content-Type: application/json
Cache-Control: no-store
Pragma: no-cache

{
    "access_token": "b77yz37w7kzy8v5fuga6zz93",
    "token_type": "bearer",
    "expires_in": 2629743,
    "refresh_token":"tGzv3JOkF0XG5Qx2TlKWIA",
}
```

====


## APIçš„è®¾è®¡æ­¥éª¤

- å…¬å¼€å“ªäº›API
- Request (Endpoint) è®¾è®¡
- Responseè®¾è®¡
- å®‰å…¨åŠè®¿é—®é™åˆ¶

====

# Request è®¾è®¡

====

## è®¾è®¡åŸåˆ™

### ä»¥èµ„æºä¸ºä¸­å¿ƒ

```
POST /accounts/1/transfer/500/to/2 ğŸ‘
```

```
POST /transaction http/1.1
host: 127.0.0.1
ã€€
from=1&to=2&amount=500.00 ğŸ‘
```

---

### ç®€çŸ­

```
http://api.example.com/service/api/users ğŸ‘
```

```
http://api.example.com/users ğŸ‘
```

---

### äººç±»å¯è¯»ï¼Œç¬¦åˆç›´è§‰

```
http://api.example.com/data/
http://api.example.com/shangpin ğŸ‘
```

```
http://api.example.com/products/12345 ğŸ‘
```

---

### ä¸æ··ç”¨å¤§å°å†™

```
http://api.example.com/Users/12345
http://example.com/API/getUserName ğŸ‘
```

```
http://api.example.com/users/12345 ğŸ‘
```

å»ºè®®ï¼šå¤§å°å†™æ•æ„Ÿï¼Œå…¨éƒ¨é‡‡ç”¨å°å†™ï¼Œå¤§å†™è¿”å›404

---

### è§„åˆ™ç»Ÿä¸€

```
http://api.example.com/friends?id=100
http://api.example.com/friend/100/message ğŸ‘
```

```
http://api.example.com/friends/100
http://api.example.com/friend/100/message ğŸ‘
```

====

## HTTP Method

- GET è·å–èµ„æº
- POST åˆ›å»ºèµ„æº
- PUT æ›´æ–°èµ„æº
- DELETE åˆ é™¤èµ„æº
- PATCH éƒ¨åˆ†æ›´æ–°èµ„æº
- HEAD è·å–èµ„æºæ¦‚è¦ä¿¡æ¯
- OPTIONS æ£€æŸ¥èµ„æºæ”¯æŒçš„Method

---

### Methodå…¼å®¹æ€§è€ƒé‡

ä½¿ç”¨Headerè¦†ç›–

```
POST /v1/users/123 HTTP/1.1
Host: api.example.com
X-HTTP-Method-Override: DELETE
```

ä½¿ç”¨POST Bodyè¦†ç›–
```
POST /v1/users/123 HTTP/1.1
Host: api.example.com

user=testuser&_method=PUT
```

====

## æ›´å¤šç»†èŠ‚


ç»Ÿä¸€ä½¿ç”¨åè¯å¤æ•°

    http://api.example.com/v1/users/12345

ä½¿ç”¨å¸¸ç”¨å•è¯

```
searchğŸ‘ findğŸ‘
photoğŸ‘ pictureğŸ‘
```

ä»…ä½¿ç”¨è‹±æ–‡+æ•°å­—

    http://api.example.com/v1/%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC/123

---

å¤šä¸ªå•è¯ä½¿ç”¨è¿å­—ç¬¦-

```
Twitter   /statuses/user_timeline
YouTube   /guideCategories
Facebook  /me/books.quotes
LinkedIn  /v1/people-search
Bit.ly    /v3/user/popular_earned_by_clicks
```

---

ä¼˜å…ˆä½¿ç”¨èµ„æºçš„å­é›†è€Œéå¼€è¾Ÿæ–°èµ„æº

```
popular-users ğŸ‘
```
```
users/popular ğŸ‘ 
```

---

è·¯å¾„ or å‚æ•°

- æ˜¯å¦èƒ½å®Œå…¨è¡¨ç¤ºèµ„æº
- æ˜¯å¦å¯ä»¥çœç•¥

---

è¿‡æ»¤

    GET /tickets
    GET /tickets?state=open
    GET /tickets?state=open,closed

---

æ’åº

    GET /tickets?sort=-priority
    GET /tickets?sort=-priority,created_at 

---

æäº¤æ•°æ®

ä½¿ç”¨JSON

---

è·å–å…³è”å­—æ®µ

    GET /tickets/12?embed=customer.name,assigned_user

```
{
  "id" : 12,
  "subject" : "I have a question!",
  "summary" : "Hi, ....",
  "customer" : {
    "name" : "Bob"
  },
  assigned_user: {
   "id" : 42,
   "name" : "Jim",
  }
}
```

====

### ç‰ˆæœ¬åŒºåˆ†

ç†è®ºæ´¾

```
GET /customers/123 HTTP/1.1
Accept: application/vnd.company.myapp.customer-v3+xml
```

å®è·µæ´¾
```
GET v3.0/customers/123 HTTP/1.1
Accept: application/xml
```
```
https://graph.facebook.com/v2.0/me
http://webservices.amazon.com/onca/xml?Service=AWSECommerceService&Version=2011-08-01
```

---

å¯èƒ½å¥½çš„è§£å†³æ–¹æ³•

- Alias + Redirection
- [Backwards-compatible API](https://stripe.com/docs/upgrades)

====

## Response è®¾è®¡

====

### æ•°æ®æ ¼å¼

```
Twitter    JSON
Facebook   JSON (éƒ¨åˆ†æ”¯æŒXML)
Foursquare JSON
Github     JSON
Amazon     XML
Flickr     XML / JSON
Yahoo      XML / JSON / PHPserialize
```

---

### æŒ‡å®šæ–¹å¼

URLå‚æ•°

    https://api.example.com/v1/users?format=xml

æ‰©å±•å

    https://api.example.com/v1/users.json

Header

```
GET /v1/users
Host: api.example.com
Accept: application/json
```

====

## è·¨åŸŸè§£å†³æ–¹æ¡ˆ

### JSONP

    callback({"id":123,"name":"Saeed"})

---

### CORS

Simple requests

```
GET /resources/public-data/ HTTP/1.1
Host: bar.other
Origin: http://foo.example
```
```
HTTP/1.1 200 OK
Access-Control-Allow-Origin: *
```

---

### CORS

Preflighted requests

```
OPTIONS /resources/post-here/ HTTP/1.1
Host: bar.other
Origin: http://foo.example
Access-Control-Request-Method: POST
Access-Control-Request-Headers: X-PINGOTHER
```
```
HTTP/1.1 200 OK
Access-Control-Allow-Origin: http://foo.example
Access-Control-Allow-Methods: POST, GET, OPTIONS
Access-Control-Allow-Headers: X-PINGOTHER
Access-Control-Max-Age: 1728000
```

====

## å“åº”å†…å®¹è®¾è®¡

### æ”¯æŒç”¨æˆ·é€‰æ‹©å­—æ®µ

    http://api.exmample.com/v1/users/12345?fields=name,age

---

### Envelopeçš„å¿…è¦æ€§

``` json
{
  "status": {
    "code": 200,
    "message": 'Success'
  },
  "response": {
     ...results...
  }
}
```

---

### å±‚æ¬¡ç»“æ„çš„å¿…è¦æ€§
```
{
    "id": 23245,
    "name": "Taro Yamada",
    "profile": {
        "birthday": 3456,
        "gender": "male",
        "languages": [ "ja", "en"]
    }
}
```
```
{
    "id": 23245,
    "name": "Taro Yamada",
    "birthday": 3456,
    "gender": "male",
    "languages": [ "ja", "en"]
}
```

---

### æ•°ç»„çš„å¤„ç†

```
[
       {
          "id": 234342,
          "name": "Taro Tanaka",
          "profileIcon": "http://image.example.com/profile/234342.png",
        },
       {
          "id": 93734,
          "name": "Hanako Yamada",
          "profileIcon": "http://image.example.com/profile/93734.png",
       },
       :
]
```
```
{
      "friends": [
         {
            "id": 234342,
            "name": "Taro Tanaka",
            "profileIcon": "http://image.example.com/profile/234342.png",
         },
         {
            "id": 93734,
            "name": "Hanako Yamada",
        },
    ]
}
```

====


## åˆ†é¡µ

- page + per_page
- offset + limit
- count + since_id + max_id [reference](https://dev.twitter.com/rest/public/timelines)

![Imgur](http://i.imgur.com/lb9kqeN.png)

---

### åˆ†é¡µä½ç½®

Github

```
Link: <https://api.github.com/user/repos?page=3&amp;per_page=100>; rel="next",
      <https://api.github.com/user/repos?page=50&amp;per_page=100>; rel="last"
```

Google

```
{
    "nextPageToken": "CKaEL",
    "items": [
        ...
    ]
}
```


---


Facebook

```
{
    "data": [
        ... Endpoint data is here
    ],
    "paging": {
        "cursors": {
            "after": "MTAxNTExOTQ1MjAwNzI5NDE=",
            "before": "NDMyNzQyODI3OTQw"
        },
        "previous": "https://graph.facebook.com/me/albums?limit=25&before=NDMyNzQyODI3OTQw"
            "next": "https://graph.facebook.com/me/albums?limit=25&after=MTAxNTExOTQ1MjAwNzI5NDE="
    }
}
```

====

### é”™è¯¯å¤„ç†

HTTP Status Code
```
1XX ä¿¡æ¯
2XX æˆåŠŸ
3XX é‡å®šå‘
4XX å®¢æˆ·ç«¯å¼•èµ·çš„é”™è¯¯
5XX æœåŠ¡å™¨ç«¯å¼•èµ·çš„é”™è¯¯
```

---

### é”™è¯¯ä¿¡æ¯ä½ç½®

```
X-MYNAME-ERROR-CODE: 2013
X-MYNAME-ERROR-MESSAGE: Bad authentication token
X-MYNAME-ERROR-INFO: http://docs.example.com/api/v1/authentication
```

```
{
    "error": {
        "code": 2013,
        "message": "Bad authentication token",
        "info": "http://docs.example.com/api/v1/authentication"
    }
}
```

---

### é”™è¯¯å†…å®¹

```
{
   "code" : 1024, //æ€»çš„é”™è¯¯ä»£ç 
   "message" : "Validation Failed", //æ€»çš„é”™è¯¯ä¿¡æ¯
   "errors": [{
       "developerMessage": "é¢å‘å¼€å‘è€…çš„é”™è¯¯ä¿¡æ¯",
       "userMessage": "é¢å‘ç”¨æˆ·çš„é”™è¯¯ä¿¡æ¯ï¼ˆi18nï¼‰",
       "code": 2013, //é”™è¯¯ä»£ç 
       "field" : "first_name", //é”™è¯¯å­—æ®µ
       "info": "http://docs.example.com/api/v1/authentication"
        //å‚è€ƒèµ„æ–™
   }]
}
```

====



## æƒé™ä¸å®‰å…¨

åŸºäºOAuth Tokençš„æƒé™éªŒè¯

```
GET /v1/users HTTP/1.1
Host: api.example.com
Authorization: Bearer b77yz37w7kzy8v5fuga6zz93
```

Tokenå¤±æ•ˆ

```
HTTP/1.1 401 Unauthorized
{
    "error":"invalid_token"
}
```

---


- å§‹ç»ˆä½¿ç”¨SSL
- HTTPsä¹Ÿéœ€è¦é˜²èŒƒä¸­é—´äººæ”»å‡»

---

- XSS
- XSRF
- å¤§é‡è®¿é—®
- More

---

é€Ÿåº¦é™åˆ¶


APIå½¢å¼

```
GET https://api.github.com/rate_limit
```

```
 {
    "resources": {
        "core": {
          "limit": 60,
          "remaining": 60,
          "reset": 1383704430
        },
        "search": {
          "limit": 5,
          "remaining": 5,
          "reset": 1383700890
        }
    }, "rate": {
        "limit": 60,
        "remaining": 60,
        "reset": 1383704430
    }
}
```

---

HTTP Headerå½¢å¼

- X-RateLimit-Limit å•ä½æ—¶é—´çš„è®¿é—®æ•°ä¸Šé™
- X-RateLimit-Remaining å‰©ä½™è®¿é—®æ•°
- X-RateLimit-Reset è®¿é—®æ•°é‡ç½®çš„æ—¶é—´


---


è¶…å‡ºè®¿é—®æ•°


```
HTTP/1.1 429 Too Many Requests
Content-Type: text/html
Retry-After: 3600


{
   "errors": [
        {
          "code": 88,
          "message": "Rate limit exceeded"
        }
  ]
}
```

---

ç»¼åˆå®ä¾‹

```
GET https://api.github.com/users/AlloVince
```


```
HTTP/1.1 200 OK
Server: GitHub.com

Date: Mon, 16 Jun 2014 21:32:36 GMT
Content-Type: application/json; charset=utf-8
Status: 200 OK
X-RateLimit-Limit: 60
X-RateLimit-Remaining: 55
X-RateLimit-Reset: 1402957018
X-XSS-Protection: 1; mode=block
X-Frame-Options: deny
Content-Security-Policy: default-src 'none'
Access-Control-Allow-Credentials: true
Access-Control-Expose-Headers: ETag, Link, X-GitHub-OTP, X-RateLimit- Limit, X-RateLimit-Remaining, X-RateLimit-Reset, X-OAuth-Scopes, X-Accepted-OAuth-Scopes, X-Poll-Interval
Access-Control-Allow-Origin: *
X-GitHub-Request-Id: 719794F7:01FB:299F044:539F6273 Strict-Transport-Security: max-age=31536000
X-Content-Type-Options: nosniff

```

====

# é¢å‘æœªæ¥

====

## REST Levels

- REST LEVEL0 - ä½¿ç”¨HTTP
- REST LEVEL1 - å¼•å…¥èµ„æºçš„æ¦‚å¿µ
- REST LEVEL2 - å¼•å…¥HTTPåŠ¨è¯(GET/POST/PUT/DELETE)
- REST LEVEL3 - å¼•å…¥HATEOAS

---

### HATEOAS

è¶…åª’ä½“å³å¼•ç”¨çŠ¶æ€å¼•æ“ï¼ˆHypermedia As The Engine Of Application State)

```
[
{
    "href": "https://api.sandbox.paypal.com/v1/payments/payment/PAY-6RV70583SB702805EKEYSZ6Y",
        "rel": "self",
        "method": "GET"
},
{
    "href": "https://www.sandbox.paypal.com/webscr?cmd=_express-checkout&token=EC-60U79048BN7719609",
    "rel": "approval_url",
    "method": "REDIRECT"
},
{
    "href": "https://api.sandbox.paypal.com/v1/payments/payment/PAY-6RV70583SB702805EKEYSZ6Y/execute",
    "rel": "execute",
    "method": "POST"
}
]
```

---

å¯èƒ½å…³è”çš„è¡Œä¸º

- self
- parent_payment
- sale
- update
- authorization
- reauthorize
- capture
- void
- refund
- delete



====

## APIçš„ç”¨æˆ·æ˜¯è°

- LSUDs (large set of unknown developers)
- SSKDs (small set of known developers)

---

RESTå¹¶ä¸èƒ½è§£å†³æ‰€æœ‰é—®é¢˜

- å¹¶ä¸æ˜¯æ‰€æœ‰ä¸šåŠ¡éƒ½èƒ½æŠ½è±¡ä¸ºèµ„æº
- æ€§èƒ½ ï¼ˆ1 Screen 1 Callï¼‰

---

éœ€è¦åæ€çš„é—®é¢˜

- è¿™æ ·è®¾è®¡æ˜¯ä¸æ˜¯åªä¸ºäº†ä¿æŒModelå­—æ®µçš„çº¯å‡€
- è¿™æ ·è®¾è®¡æ˜¯ä¸æ˜¯åªä¸ºäº†å¥½ç»´æŠ¤


---

### Expend

[OData](http://www.odata.org/)(Open Data Protocol), by Microsoft

```
GET http://services.odata.org/Northwind/Northwind.svc/Products?$format=json
```

```
GET http://services.odata.org/Northwind/Northwind.svc/Products?$format=json&$expand=Supplier
```

[More expend example](http://www.redotheweb.com/2012/08/09/how-to-design-rest-apis-for-mobile.html)

```
GET /authors?name=Tol*
```

```
GET /authors?name=Tol*&expand=books,books.reviews,books.sales,bioData
```

---

### DSL (YQL)

```
USE "http://myserver.com/mytables1.xml" as table1;
USE "http://myserver.com/mytables2.xml" as table2;
SELECT * FROM table1 WHERE id IN (select id FROM table2)
```

https://developer.yahoo.com/yql/

---

### Orchestration Layer

![Netflix](http://3.bp.blogspot.com/-3o0uVQC3hY4/UO4HrkdURDI/AAAAAAAAAfw/lWI1kWSEe9s/s1600/architecture-overview_1252.png)

http://techblog.netflix.com/2013/01/optimizing-netflix-api.html

http://www.redotheweb.com/2012/08/09/how-to-design-rest-apis-for-mobile.html


====

## Reference

![RESTFul](http://img5.douban.com/mpic/s24606499.jpg)
![Web API](http://www.oreilly.co.jp/books/images/picture978-4-87311-686-0.gif)

- [Best Practices for Designing a Pragmatic RESTful API](http://www.vinaysahni.com/best-practices-for-a-pragmatic-restful-api)
- [Best practices for API versioning](http://stackoverflow.com/questions/389169/best-practices-for-API-versioning)
- [The future of API design: The orchestration layer](http://thenextweb.com/dd/2013/12/17/future-api-design-orchestration-layer/)

====

# Thank you

====

# View this slide locally

``` shell
brew install npm
npm install -g reveal-md
wget https://gist.githubusercontent.com/AlloVince/ba8c33138adbdd39d757/raw/gistfile1.md
reveal-md gistfile1.md -s "^\n===="  -v "^\n---" -t "league"
```